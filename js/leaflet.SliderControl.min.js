L.Control.SliderControl=L.Control.extend({options:{position:"topright",layer:null,timeAttribute:"time",isEpoch:!1,startTimeIdx:0,timeStrLength:19,maxValue:-1,minValue:0,showAllOnStart:!1,markers:null,range:!1,follow:0,sameDate:!1,alwaysShowDate:!1,rezoom:null,orderMarkers:!0,orderDesc:!1,popupOptions:{},popupContent:"",showAllPopups:!0,showPopups:!0},initialize:function(e){L.Util.setOptions(this,e),this._layer=this.options.layer,L.extend(this,L.Mixin.Events)},onAdd:function(e){this.options.map=e,this.container=L.DomUtil.create("div","",this._container),this.sliderBoxContainer=L.DomUtil.create("div","slider",this.container);var t=L.DomUtil.create("div","",this.sliderBoxContainer);t.id="leaflet-slider",t.style.width="200px",L.DomUtil.create("div","ui-slider-handle",t),this.timestampContainer=L.DomUtil.create("div","slider",this.container),this.timestampContainer.id="slider-timestamp",this.timestampContainer.style.cssText="width:200px; margin-top:3px; background-color:#FFFFFF; text-align:center; border-radius:5px;display:none;",L.DomEvent.disableClickPropagation(this.sliderBoxContainer),this._map.on("mouseup",this.clearTimestamp,this);var o=this.options;if(this.options.markers=[],this._layer){var r=0,i=[];this._layer.eachLayer(function(e){i.push(e)}),o.orderMarkers&&(i=i.sort(function(e,t){var r=null,i=null;if(e.features&&e.features.properties&&e.feature.properties[o.timeAttribute]?r=e.feature.properties[o.timeAttribute]:e.options[o.timeAttribute]&&(r=e.options[o.timeAttribute]),t.features&&t.features.properties&&t.feature.properties[o.timeAttribute]?i=t.feature.properties[o.timeAttribute]:t.options[o.timeAttribute]&&(i=t.options[o.timeAttribute]),r&&i){if(r<i)return-1;if(i<r)return 1}return 0}),o.orderDesc&&(i=i.reverse()));var a=this;i.forEach(function(e){e instanceof L.LayerGroup?e.getLayers().forEach(function(e){e=a._setPopupProperty(e)}):e=a._setPopupProperty(e),o.markers[r]=e,++r}),o.maxValue=r-1,this.options=o}else console.log("Error: You have to specify a layer via new SliderControl({layer: your_layer});");return this.container},onRemove:function(e){for(i=this.options.minValue;i<=this.options.maxValue;i++)e.removeLayer(this.options.markers[i]);this.container.remove(),e.off("mouseup",this.clearTimestamp,this)},startSlider:function(){var n=this.options,p=this.extractTimestamp,e=n.minValue;n.showAllOnStart&&(e=n.maxValue,n.range?n.values=[n.minValue,n.maxValue]:n.value=n.maxValue);var u=this.timestampContainer,l=this;$(this.sliderBoxContainer).slider({range:n.range,value:n.value,values:n.values,min:n.minValue,max:n.maxValue,sameDate:n.sameDate,step:1,slide:function(e,t){var r=n.map,i=L.featureGroup();if(n.markers[t.value]){void 0!==n.markers[t.value].feature?n.markers[t.value].feature.properties[n.timeAttribute]?n.markers[t.value]&&(u.style.display="block",$(u).html(p(n.markers[t.value].feature.properties[n.timeAttribute],n))):console.error("Time property "+n.timeAttribute+" not found in data"):n.markers[t.value].options[n.timeAttribute]?n.markers[t.value]&&(u.style.display="block",$(u).html(p(n.markers[t.value].options[n.timeAttribute],n))):console.error("Time property "+n.timeAttribute+" not found in data");var o,a=[];for(o=n.minValue;o<=n.maxValue;o++)n.markers[o]&&r.removeLayer(n.markers[o]);if(n.range)for(o=t.values[0];o<=t.values[1];o++)n.markers[o]&&(a.push(n.markers[o]),r.addLayer(n.markers[o]),i.addLayer(n.markers[o]));else if(0<n.follow)for(o=t.value-n.follow+1;o<=t.value;o++)n.markers[o]&&(a.push(n.markers[o]),r.addLayer(n.markers[o]),i.addLayer(n.markers[o]));else if(n.sameDate){var s;for(s=void 0!==n.markers[t.value].feature?n.markers[t.value].feature.properties.time:n.markers[t.value].options.time,o=n.minValue;o<=n.maxValue;o++)n.markers[o].options.time==s&&(a.push(n.markers[o]),r.addLayer(n.markers[o]))}else for(o=n.minValue;o<=t.value;o++)n.markers[o]&&(a.push(n.markers[o]),r.addLayer(n.markers[o]),i.addLayer(n.markers[o]));n.showPopups&&l._openPopups(a),l.fire("rangechanged",{markers:a})}n.rezoom&&r.fitBounds(i.getBounds(),{maxZoom:n.rezoom})}}),n.alwaysShowDate&&(u.style.display="block",void 0!==n.markers[e].feature?n.markers[e].feature.properties[n.timeAttribute]?n.markers[e]&&(u.style.display="block",$(u).html(p(n.markers[e].feature.properties[n.timeAttribute],n))):console.error("Time property "+n.timeAttribute+" not found in data"):n.markers[e].options[n.timeAttribute]?n.markers[e]&&(u.style.display="block",$(u).html(p(n.markers[e].options[n.timeAttribute],n))):console.error("Time property "+n.timeAttribute+" not found in data"));var t=[];for(i=n.minValue;i<=e;i++)t.push(n.markers[i]),n.map.addLayer(n.markers[i]);n.showPopups&&this._openPopups(t),this.fire("rangechanged",{markers:t})},clearTimestamp:function(){this.options.alwaysShowDate||(this.timestampContainer.innerHTML="",this.timestampContainer.style.display="none")},extractTimestamp:function(e,t){return t.isEpoch&&(e=new Date(parseInt(e)).toString()),e.substr(t.startTimeIdx,t.startTimeIdx+t.timeStrLength)},setPosition:function(e){var t=this._map;return t&&t.removeControl(this),this.options.position=e,t&&t.addControl(this),this.startSlider(),this},_setPopupProperty:function(e){return e._popup&&(e._orgpopup=e._popup),e},_openPopups:function(e){var r=this.options,i=this;e.forEach(function(e){if(e instanceof L.LayerGroup)i._openPopups(e.getLayers());else if(e._orgpopup)e._popup=e._orgpopup,r.showAllPopups&&(e._popup.options.autoClose=!1),e.openPopup();else if(r.popupContent){var t=r.popupOptions;r.showAllPopups&&(t.autoClose=!1),e.bindPopup(r.popupContent,t).openPopup()}})}}),L.control.sliderControl=function(e){return new L.Control.SliderControl(e)};